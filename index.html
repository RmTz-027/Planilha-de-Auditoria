<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auditoria de Estoque</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to bottom,#243CE0, #3364E0, #438CE0);
      margin: 0;
      padding: 0;
      color: #333;
      background-attachment: fixed;
    }  

    .tab-container {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      background: linear-gradient(to bottom, #E55E1B, #E57C4A, #E69F7F);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .tab {
      padding: 14px 20px;
      cursor: pointer;
      background-color: transparent;
      border: none;
      outline: none;
      transition: all 0.2s ease;
      font-size: 15px;
      color: #ffffff;
      position: relative;
      overflow: hidden;
    }

    .tab.active {
      color: #007BFF;
      font-weight: 500;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background-color: #007BFF;
      transition: transform 0.3s ease;
    }

    .tab:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }

    .tab-content {
      display: none;
      background: linear-gradient(to bottom, #0000aa, #fffff);
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .tab-content.active {
      display: block;
    }

    /* Nova regra espec√≠fica para o formul√°rio de diverg√™ncia */
    .form-divergencia {
      display: none !important;
    }
    
    /* Apenas mostra quando a aba divergencia estiver ativa */
    .tab-content.active#divergencia .form-divergencia {
      display: block !important;
    }

    /* Garantir que os elementos do formul√°rio na aba diverg√™ncia sejam sempre clic√°veis */
    #divergencia input,
    #divergencia select,
    #divergencia button {
      pointer-events: auto !important;
      position: relative !important;
      z-index: 100 !important;
    }
    
    /* Garantir que o select de lista de diverg√™ncias seja vis√≠vel */
    #divergencia #listaDiv {
      opacity: 1 !important;
      visibility: visible !important;
    }

    h2, h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #444;
      font-weight: 500;
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      gap: 20px;
      padding: 15px 0;
    }

    .section {
      flex: 1;
      min-width: 300px;
      border-radius: 8px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border: 1px solid #f0f0f0;
    }

    /* Estilo para o novo seletor de endere√ßos com autocomplete */
    .endereco-selector {
      position: relative;
      margin-bottom: 20px;
    }

    .endereco-selector input {
      width: 95%;
      padding: 12px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
      background-color: #fff;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
    }

    .endereco-selector input:focus {
      border-color: #007BFF;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    .endereco-lista {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 250px;
      overflow-y: auto;
      background-color: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 0 0 6px 6px;
      z-index: 100;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      display: none;
    }

    .endereco-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .endereco-item:hover, .endereco-item.active {
      background-color: #f5f9ff;
      color: #007BFF;
    }

    .endereco-item.active {
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    input:focus, select:focus {
      border-color: #007BFF;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 14px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
      background-color: #ffffff;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 500;
      color: #555;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    /* Estilo para a linha vermelha na tabela de mercadorias */
    .linha-vermelha td {
      color: #dc3545;
      background-color: rgba(220, 53, 69, 0.05);
    }
    
    .linha-vermelha:hover td {
      background-color: rgba(220, 53, 69, 0.1);
    }

    /* Estilo para linha verde (contagem completa) */
    .linha-verde td {
      color: #ffffff;
      background-color: green;
    }
    
    .linha-verde:hover td {
      background-color: rgba(40, 167, 69, 0.1);
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      font-weight: 500;
    }
    
    .btn-adicionar {
      background-color: #007BFF;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-adicionar:hover {
      background-color: #0069d9;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .btn-adicionar span {
      font-size: 18px;
      margin-right: 5px;
      line-height: 1;
    }

    .btn-salvar {
      background-color: #28a745;
      color: white;
      width: 100%;
    }

    .btn-salvar:hover {
      background-color: #218838;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .remove-btn {
      background-color: #dc3545;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
    }

    .remove-btn:hover {
      background-color: #c82333;
    }

    .form-divergencia {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 25px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .form-divergencia h2 {
      text-align: center;
      font-size: 22px;
      margin-bottom: 25px;
      color: #333;
      font-weight: 500;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    .form-col {
      flex: 1;
      min-width: 250px;
    }

    .form-group {
      margin-bottom: 18px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
      font-size: 14px;
    }

    .form-group input, .form-group select {
      width: 90%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .form-group input:focus, .form-group select:focus {
      border-color: #007BFF;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    .form-group select {
      appearance: none;
      background: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 15l-4.243-4.243 1.415-1.414L12 12.172l2.828-2.829 1.415 1.414z" fill="rgba(0,0,0,.4)"/></svg>') no-repeat right 10px center;
      background-size: 20px;
      padding-right: 30px;
      cursor: pointer;
    }

    .form-group select:hover {
      border-color: #b0b0b0;
    }

    .form-divergencia .btn-salvar {
      background-color: #007BFF;
      color: white;
      width: 100%;
      font-size: 15px;
      padding: 12px;
      margin-top: 10px;
    }

    .form-divergencia .btn-salvar:hover {
      background-color: #0069d9;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    #mensagemRetorno {
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      text-align: center;
      font-size: 14px;
    }

    .mensagem-sucesso {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .mensagem-erro {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .campo-vazio {
      border-color: #dc3545 !important;
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
    }

    /* Estilos para o modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      overflow: auto;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: #fff;
      margin: auto;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      position: relative;
      padding: 20px;
      animation: modalFadeIn 0.3s;
    }

    @keyframes modalFadeIn {
      from {opacity: 0; transform: translateY(-30px);}
      to {opacity: 1; transform: translateY(0);}
    }

    .modal-content h2 {
      margin-top: 0;
      color: #333;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s;
    }

    .close:hover {
      color: #333;
    }

    .modal .form-group {
      margin-bottom: 15px;
    }

    .modal label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #555;
    }

    .modal input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .modal input:focus {
      border-color: #007BFF;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      outline: none;
    }

    .modal button {
      padding: 12px 15px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      width: 100%;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s ease;
    }

    .modal button:hover {
      background-color: #0069d9;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .modal button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
        gap: 10px;
      }
      
      .section {
        min-width: 100%;
      }
    }
  </style>
</head>

<body>

  <div class="tab-container">
    <button class="tab active" onclick="openTab(event, 'auditoria')">Auditoria</button>
    <button class="tab" onclick="openTab(event, 'verificacao')">Verifica√ß√£o</button>
    <button class="tab" onclick="openTab(event, 'divergencia')">Diverg√™ncia</button>
  </div>

  <!-- Conte√∫do das abas -->
  <div id="auditoria" class="tab-content active">   
    <div class="container">
      <div class="section">
        <h3>Bipe os C√≥digos</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
          <input type="text" id="codigo" placeholder="Digite o c√≥digo da mercadoria" onkeypress="buscarCodigo(event)" style="flex: 1;">                  
          </button>
        </div>
        <h3>Mercadorias Bipadas</h3>
        <table>
          <thead>
            <tr><th>C√≥digo</th><th>CF</th><th>Final</th><th>Endere√ßo</th><th>A√ß√µes</th></tr>
          </thead>
          <tbody id="mercadoriasLista"></tbody>
        </table>
        <div style="display: flex; gap: 10px;">
          <button id="btnSalvar" onclick="salvarInsercoes()">Salvar Auditoria</button>          
        </div>
      </div>

      <!-- Se√ß√£o: Endere√ßos (esquerda) -->
      <div class="section">
        <h3>Endere√ßos</h3>
        <!-- Novo seletor de endere√ßos com autocomplete -->
        <div class="endereco-selector">
          <input type="text" id="enderecoInput" placeholder="Digite ou selecione o endere√ßo" autocomplete="off" 
                 oninput="filtrarEnderecos(this.value)" onfocus="mostrarListaEnderecos('auditoria')">
          <div id="enderecosLista" class="endereco-lista"></div>
        </div>
        <h3>CFs do Endere√ßo</h3>
        <table>
          <thead>
            <tr><th>QTD</th><th>QTD Auditada</th><th>CF</th><th>Descri√ß√£o</th></tr>
          </thead>
          <tbody id="listaCFs"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Parte da Aba Verifica√ß√£o -->
  <div id="verificacao" class="tab-content">   
    <div class="endereco-selector" style="max-width: 500px; margin: 0 auto 20px auto;">
      <label for="enderecoVerificacao" style="display: block; margin-bottom: 8px; font-weight: 500;">Digite ou selecione o Endere√ßo:</label>
      <input type="text" id="enderecoVerificacao" placeholder="Digite ou selecione o endere√ßo" autocomplete="off" 
             oninput="filtrarEnderecosVerificacao(this.value)" onfocus="mostrarListaEnderecos('verificacao')">
      <div id="enderecosVerificacaoLista" class="endereco-lista"></div>
    </div>

    <table id="verificacaoTable" border="1" style="margin-top: 20px; width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>C√≥digo Produto</th>
          <th>CF</th>
          <th>Final</th>
          <th>Descri√ß√£o</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas din√¢micas v√£o aqui -->
      </tbody>
    </table>
  </div>

  <!-- Aba Diverg√™ncia -->
  <div id="divergencia" class="tab-content">
    <div class="form-divergencia">
      <h2>Registrar Diverg√™ncia</h2>
      <form id="divergenciaForm">
        <div class="form-row">
          <div class="form-col">
            <div class="form-group">
              <label for="cdMercadoria">C√≥digo da Mercadoria</label>
              <input type="text" id="cdMercadoria" placeholder="Digite o c√≥digo da mercadoria" tabindex="1">
            </div>
            <div class="form-group">
              <label for="cf">CF *</label>
              <input type="text" id="cf" required placeholder="Digite o CF" tabindex="2">
            </div>
            <div class="form-group">
              <label for="final">Final *</label>
              <input type="text" id="final" required placeholder="Digite o final" tabindex="3">
            </div>
            <div class="form-group">
              <label for="descricao">Descri√ß√£o</label>
              <input type="text" id="descricao" placeholder="Digite a descri√ß√£o do item" tabindex="4">
            </div>
          </div>
          <div class="form-col">
            <div class="form-group">
              <label for="endAuditado">Endere√ßo Auditado *</label>
              <input type="text" id="endAuditado" required placeholder="Digite o endere√ßo auditado" tabindex="5">
            </div>
            <div class="form-group">
              <label for="qtdAuditada">Quantidade Auditada *</label>
              <input type="number" id="qtdAuditada" required placeholder="Digite a quantidade" min="1" tabindex="6">
            </div>
            <div class="form-group">
              <label for="listaDiv">Lista de Diverg√™ncias *</label>
              <select id="listaDiv" required>
                <option value="">Selecione uma lista...</option>
                <option value="Alocado em Transit√≥rio">Alocado em Transit√≥rio</option>
                <option value="Avaria">Avaria</option>
                <option value="Danos por √°gua">Danos por √°gua</option>
                <option value="Duplicidade de Etiqueta">Duplicidade de Etiqueta</option>
                <option value="Embalagem Danificada">Embalagem Danificada</option>
                <option value="Erro de Endere√ßamento">Erro de Endere√ßamento</option>
                <option value="Erro de Processo">Erro de Processo</option>
                <option value="Etiqueta Danificada">Etiqueta Danificada</option>
                <option value="Etiqueta Divergente">Etiqueta Divergente</option>
                <option value="Etiqueta duplicada">Etiqueta duplicada</option>
                <option value="Falta no Endere√ßo">Falta no Endere√ßo</option>
                <option value="Furto">Furto</option>
                <option value="Item setado">Item setado</option>
                <option value="Lacre Rompido">Lacre Rompido</option>
                <option value="NL encontrado">NL encontrado</option>
                <option value="N√£o alocado no estoque">N√£o alocado no estoque</option>
                <option value="Queda">Queda</option>
                <option value="Sem Etiqueta">Sem Etiqueta</option>
              </select>
            </div>
            <div class="form-group">
              <label for="data">Data *</label>
              <input type="date" id="data" required tabindex="8">
            </div>
          </div>
        </div>
        <div id="mensagemRetorno"></div>
        <button type="button" class="btn-salvar" onclick="salvarDivergencia()" tabindex="9">
          <span class="save-icon">üìã</span> Salvar Diverg√™ncia
        </button>
      </form>
    </div>
  </div>

  <!-- Modal Novo Registro -->
  <div id="novoRegistroModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h2>Adicionar Novo Registro</h2>

      <div class="form-group">
        <label for="novoCodigo">C√≥digo da Mercadoria:</label>
        <input type="text" id="novoCodigo" placeholder="Digite o c√≥digo">
      </div>

      <div class="form-group">
        <label for="novoCF">CF:</label>
        <input type="text" id="novoCF" placeholder="Digite o CF">
      </div>

      <div class="form-group">
        <label for="novoFinal">Final:</label>
        <input type="text" id="novoFinal" placeholder="Digite o Final">
      </div>

      <div class="form-group">
        <label for="novoDescricao">Descri√ß√£o:</label>
        <input type="text" id="novoDescricao" placeholder="Digite a descri√ß√£o">
      </div>

      <div class="form-group">
        <label for="novoEndereco">Endere√ßo:</label>
        <input type="text" id="novoEndereco" placeholder="Digite o endere√ßo">
      </div>

      <button id="btnSalvarNovo" onclick="salvarNovoRegistro()">Salvar</button>
    </div>
  </div>

  
  <script>

    // Define dadosBanco como propriedade global do window para garantir acesso consistente
    window.dadosBanco = JSON.parse('<?= dadosBanco ?>');
    console.log("Banco de dados carregado com", window.dadosBanco ? window.dadosBanco.length : 0, "linhas");
    
    // Inicializa√ß√£o de vari√°veis globais
    let enderecoAtual = '';
    let enderecoVerificacaoAtual = '';
    let codigosInseridos = [];
    
    // Fun√ß√£o para verificar se um item deve ser contado na auditoria
    function itemDeveSerContado(codigoItem) {
      console.log("Verificando se item deve ser contado:", codigoItem);
      
      // Converte para string para garantir compara√ß√£o consistente
      codigoItem = String(codigoItem);
      
      // Verifica na lista de c√≥digos inseridos
      const item = codigosInseridos.find(item => String(item.codigo) === codigoItem);
      console.log("Item encontrado na lista de inseridos?", item ? "SIM" : "N√ÉO");
      
      if (!item) {
        console.log("Item n√£o est√° na lista de c√≥digos inseridos:", codigoItem);
        return false;
      }
      
      // Se o item est√° marcado explicitamente como endere√ßo errado, n√£o conta
      if (item.enderecoErrado === true) {
        console.log("Item com endere√ßo errado, n√£o ser√° contado:", codigoItem);
        return false;
      }

      // Se o item veio de um "Fora do banco", n√£o deve ser contado
      if (item.cf === "Fora do Banco de Dados") {
        console.log("Item est√° fora do banco de dados, n√£o ser√° contado:", codigoItem);
        return false;
      }
      
      // Verifica no banco de dados
      const itemBanco = window.dadosBanco.find(row => String(row[0]) === codigoItem);
      
      // Se o item n√£o existe no banco, verificar:
      // 1. se ele foi inserido manualmente (caso em que j√° tem um CF definido)
      // 2. se est√° marcado para contar (enderecoErrado === false)
      if (!itemBanco) {
        console.log("Item n√£o encontrado no banco, mas est√° na lista de inseridos.");
        
        // Para itens inseridos com CF v√°lido e n√£o marcados como endere√ßo errado,
        // contamos mesmo se n√£o est√£o no banco (podem ser rec√©m-adicionados)
        if (item.cf !== "Fora do Banco de Dados" && item.enderecoErrado === false) {
          console.log("Item ser√° contado mesmo n√£o estando no banco, pois possui CF v√°lido:", item.cf);
          return true;
        }
        
        return false;
      }
      
      // Se chegou aqui, o item existe no banco de dados, ent√£o verificamos o endere√ßo
      const endereco = itemBanco[4];
      const enderecoCorreto = endereco === enderecoAtual;
      console.log("Endere√ßo do item:", endereco, "Endere√ßo atual:", enderecoAtual, "Endere√ßo correto?", enderecoCorreto);
      
      // Se o endere√ßo no banco for diferente do atual, n√£o conta
      // independentemente do que est√° marcado na lista de inseridos
      if (!enderecoCorreto) {
        console.log("Endere√ßo no banco de dados n√£o corresponde ao endere√ßo atual, n√£o ser√° contado.");
        return false;
      }
      
      // Se chegou at√© aqui, o item deve ser contado
      console.log("Item SER√Å contado na auditoria:", codigoItem);
      return true;
    }

    function openTab(event, tabId) {
      console.log("Abrindo aba:", tabId);
      
      // 1. Esconde todas as abas e remove classes active
      var contents = document.querySelectorAll('.tab-content');
      contents.forEach(function(content) {
        content.classList.remove('active');
        content.style.display = 'none';
      });

      var tabs = document.querySelectorAll('.tab');
      tabs.forEach(function(tab) {
        tab.classList.remove('active');
      });

      // 2. Mostra a aba selecionada e adiciona classe active
      const tabElement = document.getElementById(tabId);
      tabElement.classList.add('active');
      tabElement.style.display = 'block';
      
      event.currentTarget.classList.add('active');
      
      // 3. A√ß√µes espec√≠ficas por aba
      if (tabId === 'divergencia') {
        console.log("Carregando interface da aba Diverg√™ncia");
        
        // Carregar listas e garantir que o formul√°rio esteja vis√≠vel
        carregarListas();
        
        // Aplicar foco ao primeiro campo depois de garantir visibilidade
        setTimeout(() => {
          const cdMercadoria = document.getElementById('cdMercadoria');
          if (cdMercadoria) {
            cdMercadoria.focus();
            console.log("Foco aplicado ao campo de c√≥digo da mercadoria");
          }
        }, 300);
      }
    }

    function mostrarOpcoes(dropdownId) {
      document.getElementById(dropdownId).style.display = 'block';
    }

    function carregarEnderecos() {
      console.log("Carregando endere√ßos...");
      
      if (!window.dadosBanco || !Array.isArray(window.dadosBanco)) {
        console.error("Dados do banco n√£o est√£o dispon√≠veis");
        return;
      }
      
      // Extrair endere√ßos √∫nicos
      window.enderecosList = [...new Set(window.dadosBanco
        .filter(item => item && item.length > 4 && item[4] && item[4].trim() !== "")
        .map(item => item[4].trim())
        .sort())];
      
      console.log(`Encontrados ${window.enderecosList.length} endere√ßos √∫nicos`);
    }

    function carregarEnderecosVerificacao() {
      // Usa a mesma lista carregada para auditoria
      if (!window.enderecosList) {
        carregarEnderecos();
      }
    }

    function mostrarListaEnderecos(tipo) {
      const listaId = tipo === 'auditoria' ? 'enderecosLista' : 'enderecosVerificacaoLista';
      document.getElementById(listaId).style.display = 'block';
      if (tipo === 'auditoria') {
        filtrarEnderecos(document.getElementById('enderecoInput').value);
      } else {
        filtrarEnderecosVerificacao(document.getElementById('enderecoVerificacao').value);
      }
    }

    function filtrarEnderecos(texto) {
      const listaEl = document.getElementById('enderecosLista');
      listaEl.innerHTML = '';
      listaEl.style.display = 'block';
      
      if (!window.enderecosList) {
        carregarEnderecos();
      }
      
      if (!window.enderecosList || window.enderecosList.length === 0) {
        listaEl.innerHTML = '<div class="endereco-item">Nenhum endere√ßo encontrado</div>';
        return;
      }
      
      const enderecosFiltrados = window.enderecosList.filter(endereco => 
        endereco.toLowerCase().includes(texto.toLowerCase())
      );
      
      if (enderecosFiltrados.length === 0) {
        listaEl.innerHTML = '<div class="endereco-item">Nenhum endere√ßo encontrado</div>';
        return;
      }
      
      enderecosFiltrados.forEach(endereco => {
        const item = document.createElement('div');
        item.className = 'endereco-item';
        item.textContent = endereco;
        item.onclick = function() {
          selecionarEndereco(endereco);
          listaEl.style.display = 'none';
        };
        listaEl.appendChild(item);
      });
    }

    function filtrarEnderecosVerificacao(texto) {
      const listaEl = document.getElementById('enderecosVerificacaoLista');
      listaEl.innerHTML = '';
      listaEl.style.display = 'block';
      
      if (!window.enderecosList) {
        carregarEnderecos();
      }
      
      if (!window.enderecosList || window.enderecosList.length === 0) {
        listaEl.innerHTML = '<div class="endereco-item">Nenhum endere√ßo encontrado</div>';
        return;
      }
      
      const enderecosFiltrados = window.enderecosList.filter(endereco => 
        endereco.toLowerCase().includes(texto.toLowerCase())
      );
      
      if (enderecosFiltrados.length === 0) {
        listaEl.innerHTML = '<div class="endereco-item">Nenhum endere√ßo encontrado</div>';
        return;
      }
      
      enderecosFiltrados.forEach(endereco => {
        const item = document.createElement('div');
        item.className = 'endereco-item';
        item.textContent = endereco;
        item.onclick = function() {
          selecionarEnderecoVerificacao(endereco);
          listaEl.style.display = 'none';
        };
        listaEl.appendChild(item);
      });
    }

    function selecionarEndereco(valor) {
      const input = document.getElementById("enderecoInput");
      input.value = valor;
      enderecoAtual = valor;
      document.getElementById("enderecosLista").style.display = 'none';
      
      console.log("Endere√ßo selecionado:", valor);
      
      // Carrega os CFs para o endere√ßo selecionado
      carregarCFs();
    }

    function selecionarEnderecoVerificacao(valor) {
      const input = document.getElementById("enderecoVerificacao");
      input.value = valor;
      enderecoVerificacaoAtual = valor;
      document.getElementById("enderecosVerificacaoLista").style.display = 'none';
      carregarVerificacao();
    }

    function carregarCFs() {
      const listaCFs = document.getElementById("listaCFs");
      listaCFs.innerHTML = "";

      if (!enderecoAtual) {
        console.log("Nenhum endere√ßo selecionado");
        listaCFs.innerHTML = "<tr><td colspan='4'>Selecione um endere√ßo primeiro</td></tr>";
        return;
      }

      console.log("Carregando CFs para o endere√ßo:", enderecoAtual);
      console.log("Quantidade de itens no banco:", window.dadosBanco ? window.dadosBanco.length : "n√£o definido");
      console.log("C√≥digos inseridos:", codigosInseridos);

      // Verifica se dadosBanco tem dados
      if (!window.dadosBanco || window.dadosBanco.length <= 1) {
        console.error("Dados do banco vazios ou insuficientes");
        listaCFs.innerHTML = "<tr><td colspan='4'>Erro: Dados n√£o dispon√≠veis</td></tr>";
        return;
      }

      // Mapeamento dos CFs - usando somente os dados locais
      const cfsMap = {};
      const debugInfo = { countTotal: 0, countAuditados: 0, itensVerificados: [] };
      
      console.log("Iniciando processamento de itens para o endere√ßo:", enderecoAtual);
      
      // Processa os itens do banco de dados para este endere√ßo
      window.dadosBanco.slice(1).forEach(([codigo, cf, final, descricao, end]) => {
        if (end === enderecoAtual && cf) {
          if (!cfsMap[cf]) {
            cfsMap[cf] = { qtd: 0, auditados: 0, nome: descricao, itens: [] };
          }
          cfsMap[cf].qtd++;
          debugInfo.countTotal++;
          
          // Adiciona informa√ß√£o de debug
          const isInserido = codigosInseridos.some(item => String(item.codigo) === String(codigo));
          const isEnderecoCorreto = codigosInseridos.some(item => 
            String(item.codigo) === String(codigo) && !item.enderecoErrado
          );
          
          const itemInfo = {
            codigo,
            inserido: isInserido,
            enderecoCorreto: isEnderecoCorreto
          };
          debugInfo.itensVerificados.push(itemInfo);
          cfsMap[cf].itens.push(codigo);
          
          console.log(`Item ${codigo}: CF=${cf}, Inserido=${isInserido}, EnderecoCorreto=${isEnderecoCorreto}`);
          
          // Verifica se est√° nos c√≥digos inseridos localmente
          // Apenas conta se o endere√ßo for o mesmo que est√° sendo visualizado
          if (itemDeveSerContado(codigo)) {
            cfsMap[cf].auditados++;
            debugInfo.countAuditados++;
            console.log(`Item ${codigo} SER√Å contado na auditoria para o CF ${cf}`);
          } else {
            console.log(`Item ${codigo} N√ÉO ser√° contado na auditoria para o CF ${cf}`);
          }
        }
      });
      
      // Procurar CF rec√©m-adicionado que ainda n√£o conste na lista
      // Isso √© necess√°rio porque um item rec√©m-adicionado pode n√£o ser encontrado
      // na itera√ß√£o do dadosBanco acima, mas precisamos contabiliz√°-lo
      codigosInseridos.forEach(item => {
        if (!item.enderecoErrado && item.cf !== "Fora do Banco de Dados") {
          // Verificamos se o item j√° existe no cfsMap
          let cfEncontrado = false;
          
          for (const cf in cfsMap) {
            if (cf === item.cf) {
              cfEncontrado = true;
              
              // Verificamos se o c√≥digo est√° na lista de itens deste CF
              const codigoJaContado = cfsMap[cf].itens.some(codigo => 
                String(codigo) === String(item.codigo)
              );
              
              // Se o c√≥digo n√£o estiver na lista, precisamos adicion√°-lo
              if (!codigoJaContado) {
                console.log(`Adicionando item rec√©m-inserido ${item.codigo} ao CF ${cf}`);
                cfsMap[cf].itens.push(item.codigo);
                
                // Neste caso, como j√° foi verificado que o item n√£o tem endere√ßo errado,
                // incrementamos a contagem de auditados
                cfsMap[cf].auditados++;
              }
            }
          }
          
          // Se o CF n√£o existir no mapeamento, criamos uma nova entrada
          if (!cfEncontrado) {
            console.log(`Criando novo CF ${item.cf} para item rec√©m-inserido ${item.codigo}`);
            
            // Pegamos a descri√ß√£o do item do banco de dados se dispon√≠vel
            const itemBanco = window.dadosBanco.find(row => String(row[0]) === String(item.codigo));
            const descricao = itemBanco ? itemBanco[3] : "Item rec√©m-adicionado";
            
            cfsMap[item.cf] = {
              qtd: 1,      // Assume que s√≥ existe 1 item deste CF neste endere√ßo
              auditados: 1, // Este item j√° est√° na lista, ent√£o conta como auditado
              nome: descricao,
              itens: [item.codigo]
            };
          }
        }
      });
      
      console.log("Mapeamento de CFs final:", cfsMap);
      console.log("Informa√ß√µes de debug:", debugInfo);
      
      // Verifica se encontrou algum CF para o endere√ßo
      if (Object.keys(cfsMap).length === 0) {
        console.log("Nenhum CF encontrado para o endere√ßo:", enderecoAtual);
        listaCFs.innerHTML = "<tr><td colspan='4'>Nenhum CF encontrado para este endere√ßo</td></tr>";
        return;
      }
      
      // Converte o objeto cfsMap em um array para poder ordenar
      const cfsSorted = Object.entries(cfsMap)
        .map(([cf, data]) => ({
          cf,
          qtd: data.qtd,
          auditados: data.auditados,
          nome: data.nome
        }))
        .sort((a, b) => b.qtd - a.qtd); // Ordena do maior para o menor
      
      // Renderiza a tabela de CFs
      let html = '';
      cfsSorted.forEach(item => {
        const isCompleto = item.qtd === item.auditados;
        const row = `
          <tr class="${isCompleto ? 'linha-verde' : ''}">
            <td>${item.qtd}</td>
            <td>${item.auditados}</td>
            <td>${item.cf}</td>
            <td>${item.nome}</td>
          </tr>
        `;
        listaCFs.insertAdjacentHTML('beforeend', row);
      });
      
      console.log("Tabela de CFs atualizada com sucesso.");
    }

    function carregarVerificacao() {
      const tbody = document.getElementById("verificacaoTable").querySelector("tbody");
      tbody.innerHTML = ""; // Limpa antes de listar

      if (!enderecoVerificacaoAtual) return;

      // Pega os produtos do endere√ßo selecionado no banco de dados
      const produtosEndereco = window.dadosBanco
        .slice(1) // Ignora o cabe√ßalho
        .filter(row => row[4] === enderecoVerificacaoAtual)
        .map(([codigo, cf, final, descricao]) => ({ codigo, cf, final, descricao }));

      produtosEndereco.forEach(produto => {
        const auditado = codigosInseridos.some(item => item.codigo === produto.codigo);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${produto.codigo}</td>
          <td>${produto.cf}</td>
          <td>${produto.final}</td>
          <td>${produto.descricao}</td>
          <td style="color: ${auditado ? 'green' : 'red'}; font-weight: bold;">
            ${auditado ? 'Auditado' : 'Faltando'}
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    function buscarCodigo(event) {
      if (event.key !== "Enter") return;

      const codigoInput = document.getElementById("codigo");
      const codigo = codigoInput.value.trim();

      if (!codigo || !enderecoAtual) {
        alert("Digite o c√≥digo e selecione um endere√ßo.");
        return;
      }

      // Normaliza o c√≥digo para compara√ß√£o (remove espa√ßos e converte para string)
      const codigoNormalizado = String(codigo).trim();
      
      // Verifica se o c√≥digo j√° foi inserido (usando a vers√£o normalizada)
      if (codigosInseridos.some(item => String(item.codigo).trim() === codigoNormalizado)) {
        // Toca um som de alerta
        const audio = new Audio('data:audio/wav;base64,//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=');
        audio.play();
        
        alert("C√≥digo j√° inserido.");
        codigoInput.value = "";
        codigoInput.focus();
        return;
      }

      // Certifique-se de que dadosBanco est√° definido
      if (!window.dadosBanco) {
        alert("Erro: Banco de dados n√£o carregado corretamente.");
        return;
      }

      console.log("Procurando c√≥digo:", codigoNormalizado);
      console.log("Banco de dados atual:", window.dadosBanco);

      // Procura a mercadoria no banco de dados atualizado (usando a vers√£o normalizada)
      const mercadoria = window.dadosBanco.find(row => String(row[0]).trim() === codigoNormalizado);
      
      if (mercadoria) {
        console.log("Mercadoria encontrada:", mercadoria);
      } else {
        console.log("Mercadoria n√£o encontrada para o c√≥digo:", codigoNormalizado);
      }

      const tabela = document.getElementById("mercadoriasLista");
      const row = document.createElement("tr");

      if (mercadoria) {
        const [cod, cf, final, descricao, endereco] = mercadoria;

        row.innerHTML = `
          <td>${cod}</td>
          <td>${cf}</td>
          <td>${final}</td>
          <td>${endereco}</td>
          <td><button class="remove-btn" onclick="removerItem('${cod}', this)">Remover</button></td>
        `;

        // Verifica se o endere√ßo da mercadoria √© diferente do endere√ßo selecionado
        const enderecoErrado = (endereco !== enderecoAtual);
        
        if (enderecoErrado) {
          row.classList.add("linha-vermelha");
          row.title = "Este item est√° em um endere√ßo diferente do selecionado";
        }

        // Adiciona √† lista de c√≥digos inseridos (usando o c√≥digo normalizado)
        codigosInseridos.unshift({ 
          codigo: codigoNormalizado, 
          cf: cf, 
          enderecoErrado: enderecoErrado 
        });
      } else {
        row.innerHTML = `
          <td>${codigoNormalizado}</td>
          <td>Fora do Banco de Dados</td>
          <td>-</td>
          <td>-</td>
          <td>
            <button class="remove-btn" onclick="removerItem('${codigoNormalizado}', this)">Remover</button>
            <button onclick="abrirModalAdicionar('${codigoNormalizado}')">Adicionar</button>
          </td>
        `;
        row.classList.add("linha-vermelha");
        row.classList.add("fora-banco");
        row.title = "Este item n√£o foi encontrado no banco de dados";

        codigosInseridos.unshift({ 
          codigo: codigoNormalizado, 
          cf: "Fora do Banco de Dados", 
          enderecoErrado: true 
        });
      }

      tabela.prepend(row);
      carregarCFs();

      codigoInput.value = "";
      codigoInput.focus();
    }

    function removerItem(codigo, button) {
      // Encontra o √≠ndice do item a ser removido
      const index = codigosInseridos.findIndex(item => String(item.codigo) === String(codigo));
      
      if (index !== -1) {
        // Remove da lista
        codigosInseridos.splice(index, 1);
        console.log("Item removido da lista. Total restante:", codigosInseridos.length);
        
        // Remove da tabela
        button.closest("tr").remove();
        
        // Atualiza a contagem
        carregarCFs();
      }
    }
    
    // Fun√ß√£o para remover item pelo c√≥digo sem precisar do bot√£o
    function removerItemPorCodigo(codigo) {
      // Remove da estrutura de dados
      codigosInseridos = codigosInseridos.filter(item => String(item.codigo) !== String(codigo));
      
      // Remove da tabela visualmente
      const tabela = document.getElementById("mercadoriasLista");
      const linhas = tabela.querySelectorAll("tr");
      
      for (let i = 0; i < linhas.length; i++) {
        const colunas = linhas[i].querySelectorAll("td");
        if (colunas.length > 0 && String(colunas[0].textContent) === String(codigo)) {
          console.log("Removendo linha com c√≥digo:", codigo);
          linhas[i].remove();
          break;
        }
      }
      
      // Atualiza a contagem
      carregarCFs();
    }
    
    // Fun√ß√£o para salvar um c√≥digo individual na BASE DO SCRIPT (uso opcional)
    function salvarCodigoNaBase(codigo) {
      if (!enderecoAtual) {
        console.error("Endere√ßo atual n√£o definido, n√£o √© poss√≠vel salvar na base");
        return;
      }
      
      console.log("Salvando c√≥digo na BASE DO SCRIPT:", codigo, "Endere√ßo:", enderecoAtual);
      
      google.script.run
        .withSuccessHandler((resposta) => {
          console.log("C√≥digo salvo na BASE DO SCRIPT com sucesso");
        })
        .withFailureHandler((erro) => {
          console.error("Erro ao salvar c√≥digo na BASE DO SCRIPT:", erro);
        })
        .registrarCodigoNaBase(codigo, enderecoAtual);
    }

    function salvarInsercoes() {
      if (codigosInseridos.length === 0) {
        alert("Nenhum c√≥digo para salvar.");
        return;
      }

      // Verifica se h√° c√≥digos fora do banco de dados
      if (codigosInseridos.some(item => item.cf === "Fora do Banco de Dados")) {
        alert("Remova os c√≥digos fora do banco antes de salvar!");
        return;
      }
      
      // Verifica se h√° c√≥digos com endere√ßo errado
      const itensComEnderecoErrado = codigosInseridos.filter(item => item.enderecoErrado);
      if (itensComEnderecoErrado.length > 0) {
        const confirmacao = confirm(
          `Aten√ß√£o: Existem ${itensComEnderecoErrado.length} c√≥digo(s) em endere√ßo diferente do atual.\n` +
          `Estes itens N√ÉO ser√£o contabilizados na contagem do endere√ßo atual.\n\n` +
          `Deseja continuar mesmo assim?`
        );
        
        if (!confirmacao) {
          return;
        }
      }

      // Preparar os dados para enviar: c√≥digo + endere√ßo atual
      const dadosParaSalvar = codigosInseridos.map(item => ({
        codigo: item.codigo,
        endereco: enderecoAtual
      }));

      console.log("Enviando dados para salvar:", dadosParaSalvar);

      google.script.run
        .withSuccessHandler((resposta) => {
          console.log("Resposta do servidor:", resposta);
          alert("Inser√ß√µes salvas com sucesso!");
          codigosInseridos = [];
          document.getElementById("mercadoriasLista").innerHTML = "";
          carregarCFs();
        })
        .withFailureHandler((erro) => {
          console.error("Erro ao salvar inser√ß√µes:", erro);
          alert("Erro ao salvar inser√ß√µes: " + (erro.message || erro.toString() || "Erro desconhecido"));
        })
        .salvarCodigosInseridos(dadosParaSalvar);
    }

    function abrirModalAdicionar(codigo) {
      const modal = document.getElementById("novoRegistroModal");
      document.getElementById("novoCodigo").value = codigo;
      document.getElementById("novoEndereco").value = enderecoAtual;
      modal.classList.add("show");
    }

    function fecharModal() {
      const modal = document.getElementById('novoRegistroModal');
      modal.classList.remove('show');
    }

    function salvarNovoRegistro() {
      try {
        console.log("Iniciando fun√ß√£o salvarNovoRegistro");
        const codigo = document.getElementById("novoCodigo").value.trim();
        const cf = document.getElementById("novoCF").value.trim();
        const final = document.getElementById("novoFinal").value.trim();
        const descricao = document.getElementById("novoDescricao").value.trim();
        const endereco = document.getElementById("novoEndereco").value.trim();

        console.log("Valores obtidos dos campos:", {codigo, cf, final, descricao, endereco});

        if (!codigo || !cf || !final || !descricao || !endereco) {
          alert("Preencha todos os campos.");
          return;
        }

        const novoRegistro = { codigo, cf, final, descricao, endereco };
        
        console.log("Enviando novo registro:", novoRegistro);
        
        // Desabilita o bot√£o para evitar cliques m√∫ltiplos
        const btnSalvar = document.getElementById("btnSalvarNovo");
        btnSalvar.disabled = true;
        btnSalvar.textContent = "Salvando...";

        google.script.run
          .withSuccessHandler((novosDados) => {
            console.log("Resposta do servidor recebida com sucesso, processando dados...");
            try {
              // Atualiza o banco de dados local com os novos dados
              window.dadosBanco = JSON.parse(novosDados);
              console.log("Banco de dados atualizado com", window.dadosBanco.length, "linhas");
              
              // Verificar se o item realmente foi adicionado ao banco de dados
              const itemAdicionado = window.dadosBanco.some(row => 
                String(row[0]) === String(codigo) && 
                String(row[1]) === String(cf) && 
                String(row[4]) === String(endereco)
              );
              
              console.log("Item adicionado ao banco de dados?", itemAdicionado ? "SIM" : "N√ÉO");
              
              if (!itemAdicionado) {
                console.error("ALERTA: N√£o foi poss√≠vel encontrar o item no banco ap√≥s adi√ß√£o!");
              }
              
              // Remover a linha vermelha do item que acabamos de adicionar
              console.log("Removendo linha vermelha do c√≥digo:", codigo);
              removerItemPorCodigo(codigo);

              // Fechar o modal
              fecharModal();
              
              // Se o endere√ßo do item adicionado for igual ao endere√ßo atual, adiciona-o √† lista
              if (endereco === enderecoAtual) {
                console.log("Item adicionado pertence ao endere√ßo atual, adicionando √† lista");
                
                // Adiciona o item √† tabela de mercadorias com os dados corretos
                const tabela = document.getElementById("mercadoriasLista");
                const row = document.createElement("tr");
                row.innerHTML = `
                  <td>${codigo}</td>
                  <td>${cf}</td>
                  <td>${final}</td>
                  <td>${endereco}</td>
                  <td><button class="remove-btn" onclick="removerItem('${codigo}', this)">Remover</button></td>
                `;
                
                // Adiciona √† lista de c√≥digos inseridos (sem marcar como endere√ßo errado)
                codigosInseridos.unshift({ 
                  codigo: codigo, 
                  cf: cf, 
                  enderecoErrado: false
                });
                
                console.log("Item adicionado √† lista de c√≥digos inseridos:", {
                  codigo, cf, enderecoErrado: false
                });
                
                // Adiciona √† tabela
                tabela.prepend(row);
                
                // For√ßa atualiza√ß√£o da contagem para refletir o novo item imediatamente
                console.log("Atualizando contagem da tabela de CFs com o novo item...");
                carregarCFs();
              } else {
                console.log("Item adicionado N√ÉO pertence ao endere√ßo atual:", endereco);
                alert("Item adicionado ao banco com sucesso, mas n√£o ser√° inclu√≠do na contagem atual pois o endere√ßo n√£o corresponde ao endere√ßo selecionado.");
                
                // Mesmo para itens em outro endere√ßo, precisamos atualizar para remover o item
                // da lista de itens em vermelho
                carregarCFs();
              }
              
              // Recarrega as interfaces
              carregarEnderecos();
              carregarEnderecosVerificacao();
              
              alert("Registro adicionado com sucesso!");
            } catch (erro) {
              console.error("Erro ao processar resposta:", erro);
              alert("Erro ao processar resposta: " + erro.message);
            } finally {
              // Reabilita o bot√£o
              btnSalvar.disabled = false;
              btnSalvar.textContent = "Salvar";
            }
          })
          .withFailureHandler((erro) => {
            console.error("Erro retornado pelo servidor:", erro);
            alert("Erro ao adicionar registro: " + (erro.message || erro.toString() || "Erro desconhecido"));
            // Reabilita o bot√£o
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar";
          })
          .adicionarNovoRegistro(novoRegistro);
        console.log("Chamada ass√≠ncrona iniciada");
      } catch (erro) {
        console.error("Erro inesperado na fun√ß√£o salvarNovoRegistro:", erro);
        alert("Erro inesperado: " + erro.message);
      }
    }

    function carregarListas() {
      console.log("Iniciando carregamento das listas...");
      const selectLista = document.getElementById('listaDiv');
      
      // Verificar se o elemento existe
      if (!selectLista) {
        console.error("Elemento select #listaDiv n√£o encontrado");
        return;
      }
      
      selectLista.innerHTML = '';
      
      // Lista de op√ß√µes simplificada, sem categorias, ordenada alfabeticamente
      const listaOpcoes = [
        "Alocado em Transit√≥rio",
        "Avaria",
        "Danos por √°gua",
        "Duplicidade de Etiqueta",
        "Embalagem Danificada",
        "Erro de Endere√ßamento",
        "Erro de Processo",
        "Etiqueta Danificada",
        "Etiqueta Divergente",
        "Etiqueta duplicada",
        "Falta no Endere√ßo",
        "Furto",
        "Item setado",
        "Lacre Rompido",
        "NL encontrado",
        "N√£o alocado no estoque",
        "Queda",
        "Sem Etiqueta"
      ].sort();
      
      // Criar op√ß√£o default primeiro
      const optionDefault = document.createElement('option');
      optionDefault.value = "";
      optionDefault.textContent = "Selecione uma lista...";
      selectLista.appendChild(optionDefault);
      
      // Adicionar cada op√ß√£o ao select
      listaOpcoes.forEach(lista => {
        const option = document.createElement('option');
        option.value = lista;
        option.textContent = lista;
        selectLista.appendChild(option);
      });
      
      console.log("Listas de diverg√™ncia carregadas:", listaOpcoes.length);
      
      // Verificar se o select est√° vis√≠vel e interativo
      setTimeout(() => {
        if (selectLista) {
          selectLista.style.opacity = '1';
          selectLista.style.pointerEvents = 'auto';
          
          // Testar se √© poss√≠vel clicar
          try {
            selectLista.focus();
            console.log("Foco aplicado ao campo de lista");
          } catch (e) {
            console.error("Erro ao aplicar foco:", e);
          }
        }
      }, 300);
    }

    function salvarDivergencia() {
      console.log("Iniciando salvar diverg√™ncia...");
      
      // Limpar classes de erro anteriores
      document.querySelectorAll('.campo-vazio').forEach(campo => {
        campo.classList.remove('campo-vazio');
      });
      
      // Obter valores dos campos na nova ordem
      const cdMercadoria = document.getElementById('cdMercadoria').value.trim();
      const cf = document.getElementById('cf').value.trim();
      const final = document.getElementById('final').value.trim();
      const descricao = document.getElementById('descricao').value.trim();
      const endAuditado = document.getElementById('endAuditado').value.trim();
      const qtdAuditada = document.getElementById('qtdAuditada').value.trim();
      const listaDiv = document.getElementById('listaDiv').value.trim();
      const data = document.getElementById('data').value;
      
      console.log("Valores obtidos dos campos:", {
        cdMercadoria, cf, final, descricao, endAuditado, qtdAuditada, listaDiv, data
      });
      
      const mensagemRetorno = document.getElementById('mensagemRetorno');
      mensagemRetorno.className = '';
      mensagemRetorno.textContent = '';

      // Validar campos obrigat√≥rios
      let camposInvalidos = false;
      const camposObrigatorios = [
        { id: 'cf', valor: cf, nome: 'CF' },
        { id: 'final', valor: final, nome: 'Final' },
        { id: 'endAuditado', valor: endAuditado, nome: 'Endere√ßo Auditado' },
        { id: 'qtdAuditada', valor: qtdAuditada, nome: 'Quantidade Auditada' },
        { id: 'listaDiv', valor: listaDiv, nome: 'Lista de Diverg√™ncias' },
        { id: 'data', valor: data, nome: 'Data' }
      ];
      
      const camposFaltando = [];
      
      camposObrigatorios.forEach(campo => {
        if (!campo.valor) {
          document.getElementById(campo.id).classList.add('campo-vazio');
          camposInvalidos = true;
          camposFaltando.push(campo.nome);
        }
      });
      
      if (camposInvalidos) {
        mensagemRetorno.textContent = `Preencha os campos obrigat√≥rios: ${camposFaltando.join(', ')}`;
        mensagemRetorno.classList.add('mensagem-erro');
        return;
      }

      // Preparar dados para salvar
      const dados = {
        Lista: listaDiv,
        CdMercadoria: cdMercadoria,
        Descricao: descricao,
        CF: cf,
        Final: final,
        EndeAud: endAuditado,
        Data: data,
        Qtd: qtdAuditada
      };

      // Desabilitar bot√£o durante processamento
      const btnSalvar = document.querySelector('.btn-salvar');
      const textoOriginal = btnSalvar.innerHTML;
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="save-icon">‚è≥</span> Salvando...';
      
      console.log("Enviando dados para o servidor:", dados);

      // Chamada ao servidor
      google.script.run
        .withSuccessHandler(function(resposta) {
          console.log("Resposta de sucesso do servidor:", resposta);
          mensagemRetorno.textContent = resposta;
          mensagemRetorno.classList.add('mensagem-sucesso');
          
          // Limpar o formul√°rio
          document.getElementById('divergenciaForm').reset();
          
          // Definir a data atual
          document.getElementById('data').value = new Date().toISOString().split('T')[0];
          
          // Reabilitar o bot√£o
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
          
          // Recarregar as listas
          carregarListas();
        })
        .withFailureHandler(function(erro) {
          console.error("Erro retornado pelo servidor:", erro);
          mensagemRetorno.textContent = 'Erro: ' + (erro.message || erro);
          mensagemRetorno.classList.add('mensagem-erro');
          
          // Reabilitar o bot√£o
          btnSalvar.disabled = false;
          btnSalvar.innerHTML = textoOriginal;
        })
        .SalvarDivergencia(dados);
    }

    // Fun√ß√£o para carregar os dados do banco na inicializa√ß√£o
    function carregarDadosBanco() {
      console.log("Inicializando dados do banco");
      
      // Verificar se window.dadosBanco est√° definido corretamente
      if (!window.dadosBanco || !Array.isArray(window.dadosBanco) || window.dadosBanco.length === 0) {
        console.error("ERRO: Dados do banco n√£o foram carregados corretamente");
        alert("Erro ao carregar dados. Por favor, recarregue a p√°gina.");
        return;
      }
      
      console.log("Dados do banco carregados com sucesso:", window.dadosBanco.length, "linhas");
    }

    // Modifique seu evento DOMContentLoaded para incluir a chamada para carregarListas
    document.addEventListener('DOMContentLoaded', () => {
      console.log("Iniciando carregamento da p√°gina");
      
      // Primeiro carregar os dados do banco
      carregarDadosBanco();
      
      // Verificar se os dados foram carregados corretamente antes de prosseguir
      if (window.dadosBanco && Array.isArray(window.dadosBanco) && window.dadosBanco.length > 0) {
        console.log("Dados do banco verificados, prosseguindo com carregamento de interfaces");
        // Agora carregar os componentes da interface que dependem dos dados
        carregarEnderecos();
        carregarEnderecosVerificacao();
        carregarListas();
      } else {
        console.error("N√£o foi poss√≠vel carregar interfaces dependentes devido a problemas com dados do banco");
        alert("Erro ao carregar dados do banco. Algumas funcionalidades podem n√£o estar dispon√≠veis.");
      }
      
      // Define a data atual no campo de data da aba de diverg√™ncia (isso n√£o depende do banco)
      const dataAtual = new Date().toISOString().split('T')[0];
      const campoData = document.getElementById('data');
      if (campoData) {
        campoData.value = dataAtual;
      }
      
      // Fechar dropdown quando clica fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.endereco-selector')) {
          document.querySelectorAll('.endereco-lista').forEach(lista => {
            lista.style.display = 'none';
          });
        }
      });
      
      // Detectar cliques no formul√°rio de diverg√™ncia
      const divergenciaForm = document.getElementById('divergenciaForm');
      if (divergenciaForm) {
        divergenciaForm.addEventListener('click', function(e) {
          console.log("Clique detectado no formul√°rio de diverg√™ncia:", e.target.tagName, e.target.id);
        });
      }
      
      // Adicionar evento para carregar listas quando a aba de diverg√™ncia for selecionada
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function(event) {
          if (this.textContent.trim() === 'Diverg√™ncia') {
            console.log("Tab Diverg√™ncia clicada");
            
            // For√ßar renderiza√ß√£o adequada da aba antes de trabalhar com o formul√°rio
            setTimeout(() => {
              // Chamar carregamento de listas com um atraso para garantir que a aba est√° vis√≠vel
              carregarListas();
            }, 100);
          }
        });
      });
      
      // Adicionar event listener para fechar o dropdown quando clicar fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.endereco-selector')) {
          document.querySelectorAll('.endereco-lista').forEach(lista => {
            lista.style.display = 'none';
          });
        }
      });
      
      // Adicionar event listener para navega√ß√£o por teclado
      document.addEventListener('keydown', function(e) {
        // Verifica se alguma lista de endere√ßos est√° vis√≠vel
        const listaVisivel = document.querySelector('.endereco-lista[style*="display: block"]');
        if (!listaVisivel) return;
        
        const itens = listaVisivel.querySelectorAll('.endereco-item');
        if (itens.length === 0) return;
        
        const inputAtivo = document.activeElement;
        let itemAtivo = listaVisivel.querySelector('.endereco-item.active');
        let indexAtivo = -1;
        
        if (itemAtivo) {
          for (let i = 0; i < itens.length; i++) {
            if (itens[i] === itemAtivo) {
              indexAtivo = i;
              break;
            }
          }
        }
        
        switch (e.key) {
          case 'ArrowDown':
            e.preventDefault();
            if (itemAtivo) itemAtivo.classList.remove('active');
            indexAtivo = (indexAtivo + 1) % itens.length;
            itens[indexAtivo].classList.add('active');
            listaVisivel.scrollTop = itens[indexAtivo].offsetTop - listaVisivel.offsetHeight / 2;
            break;
            
          case 'ArrowUp':
            e.preventDefault();
            if (itemAtivo) itemAtivo.classList.remove('active');
            indexAtivo = (indexAtivo - 1 + itens.length) % itens.length;
            itens[indexAtivo].classList.add('active');
            listaVisivel.scrollTop = itens[indexAtivo].offsetTop - listaVisivel.offsetHeight / 2;
            break;
            
          case 'Enter':
            e.preventDefault();
            if (itemAtivo) {
              itemAtivo.click();
            }
            break;
            
          case 'Escape':
            e.preventDefault();
            listaVisivel.style.display = 'none';
            break;
        }
      });
      
      console.log("Inicializa√ß√£o da p√°gina conclu√≠da");
    });

    // Fechar o modal quando clicar fora dele ou pressionar ESC
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('novoRegistroModal');
      if (e.target === modal) {
        fecharModal();
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('novoRegistroModal');
        if (modal.classList.contains('show')) {
          fecharModal();
        }
      }
    });

    

  </script>
</body>
</html>